about: Catalog of virtual products for MAHTS analysis
products:
    ls8_nbart:
        recipe:
            &ls8_nbart_recipe
            product: ga_ls8c_ard_3
            measurements: [nbart_blue, nbart_green, nbart_red, nbart_nir, nbart_swir_1, nbart_swir_2, oa_nbart_contiguity, oa_fmask]
            gqa_iterative_mean_xy: [0, 1]
            group_by: solar_day
            
    ls7_nbart:
         recipe:
            &ls7_nbart_recipe
             <<: *ls8_nbart_recipe
             product: ga_ls7e_ard_3

    ls5_nbart:
         recipe:
            &ls5_nbart_recipe
             <<: *ls8_nbart_recipe
             product: ga_ls5t_ard_3
             
    ls_nbart:
         recipe:
             &ls_nbart_recipe
             transform: expressions
             output:
                 blue:
                     formula: nbart_blue * 0.0001
                     dtype: float32
                 green:
                     formula: nbart_green * 0.0001
                     dtype: float32
                 red: 
                     formula: nbart_red * 0.0001
                     dtype: float32
                 nir: 
                     formula: nbart_nir * 0.0001
                     dtype: float32
                 swir1: 
                     formula: nbart_swir_1 * 0.0001
                     dtype: float32
                 swir2: 
                     formula: nbart_swir_2 * 0.0001
                     dtype: float32
                 fmask: 
                     formula: ((oa_fmask == 1) | (oa_fmask == 4) | (oa_fmask == 5))
                 contiguity:
                     formula: oa_nbart_contiguity
                     dtype: bool
             input:
                 collate:
                     - *ls5_nbart_recipe
                     - *ls7_nbart_recipe
                     - *ls8_nbart_recipe
                     
    ls_nbart_masked:
        recipe:
            &ls_nbart_masked
            transform: apply_mask
            mask_measurement_name: fmask
            input:
                transform: expressions
                output:
                    blue: blue
                    green: green
                    red: red
                    nir: nir
                    swir1: swir1
                    swir2: swir2
                    fmask: fmask
                input: *ls_nbart_recipe
                
    ls_nbart_indices:
         recipe:
             transform: expressions
             output:
                 mndwi:
                    formula: (green - swir1) / (green + swir1)
                 ndwi:
                    formula: (green - nir) / (green + nir)
                 awei_ns:
                    formula: (4 * (green - swir1) - (0.25 * nir * + 2.75 * swir2))
                 awei_sh:
                    formula: (blue + 2.5 * green - 1.5 * (nir + swir1) - 0.25 * swir2)
                 ndbi:
                    formula: (swir1 - nir) / (swir1 + nir)
             input: *ls_nbart_masked
                
                

    s2a_ard_granule_simple:
        recipe:
            product: s2a_ard_granule

    s2a_nbart_rgb:
        recipe:
            product: s2a_ard_granule
            measurements: [nbart_blue, nbart_green, nbart_red]

    s2a_nbart_rgb_renamed:
        recipe:
            transform: expressions
            output:
                blue: nbart_blue
                green: nbart_green
                red: nbart_red
            input:
                product: s2a_ard_granule
                measurements: [nbart_blue, nbart_green, nbart_red]

    s2a_nbart_rgb_nodata_masked:
        recipe:
            transform: expressions
            output:
                blue:
                    formula: nbart_blue
                    dtype: float32
                green:
                    formula: nbart_green
                    dtype: float32
                red:
                    formula: nbart_red
                    dtype: float32
            input:
                product: s2a_ard_granule
                measurements: [nbart_blue, nbart_green, nbart_red]

    s2a_nbart_rgb_and_fmask:
        recipe:
            product: s2a_ard_granule
            measurements: [nbart_blue, nbart_green, nbart_red, fmask]

    s2a_nbart_rgb_and_fmask_native:
        recipe:
            product: s2a_ard_granule
            like: fmask
            measurements: [nbart_blue, nbart_green, nbart_red, fmask]
            resampling:
                fmask: nearest
                '*': average

    s2a_nbart_rgb_and_fmask_albers:
        recipe:
            &s2a_albers_recipe
            product: s2a_ard_granule
            measurements: [nbart_blue, nbart_green, nbart_red, fmask]
            output_crs: EPSG:3577
            resolution: [-20, 20]
            resampling:
                fmask: nearest
                '*': average

    s2a_fmask:
        recipe:
            transform: make_mask
            mask_measurement_name: fmask
            flags:
                fmask: valid
            input:
                product: s2a_ard_granule
                measurements: [fmask]

    s2a_cloud_free_nbart_rgb_albers:
        recipe:
            &s2a_cloud_free_recipe
            transform: apply_mask
            mask_measurement_name: fmask
            preserve_dtype: False
            input:
                transform: make_mask
                mask_measurement_name: fmask
                flags:
                    fmask: valid
                input: *s2a_albers_recipe
                
    s2a_cloud_free_nbart_rgb_albers_reprojected:
        recipe:
            reproject:
                output_crs: EPSG:3577
                resolution: [-20, 20]
            resampling: average
            input:
                transform: apply_mask
                mask_measurement_name: fmask
                preserve_dtype: False
                input:
                    transform: make_mask
                    mask_measurement_name: fmask
                    flags:
                        fmask: valid
                    input:
                        product: s2a_ard_granule
                        measurements: [nbart_blue, nbart_green, nbart_red, fmask]
                        like: fmask
                        resampling: average


    s2a_cloud_free_nbart_rgb_albers_dilated:
        recipe:
            <<: *s2a_cloud_free_recipe
            dilation: 10

    s2a_NDVI:
        recipe:
            transform: expressions
            output:
                NDVI:
                    formula: (nbart_nir_1 - nbart_red) / (nbart_nir_1 + nbart_red)
                    dtype: float32
            input:
                product: s2a_ard_granule
                measurements: [nbart_red, nbart_nir_1]

    s2a_tasseled_cap:
        recipe:
            transform: expressions
            output:
                brightness:
                    formula: 0.2043 * nbart_blue + 0.4158 * nbart_green + 0.5524 * nbart_red + 0.5741 * nbart_nir_1 + 0.3124 * nbart_swir_2 + -0.2303 * nbart_swir_3
                    dtype: float32
                greenness:
                    formula: -0.1603 * nbart_blue + -0.2819 * nbart_green + -0.4934 * nbart_red + 0.7940 * nbart_nir_1 + -0.0002 * nbart_swir_2 + -0.1446 * nbart_swir_3
                    dtype: float32
                wetness:
                    formula: 0.0315 * nbart_blue + 0.2021 * nbart_green + 0.3102 * nbart_red + 0.1594 * nbart_nir_1 + -0.6806 * nbart_swir_2 + -0.6109 * nbart_swir_3
                    dtype: float32
            input:
                product: s2a_ard_granule
                measurements: [nbart_blue, nbart_green, nbart_red, nbart_nir_1, nbart_swir_2, nbart_swir_3]
                output_crs: EPSG:3577
                resolution: [-20, 20]
                resampling: average

    s2a_cloud_free_tasseled_cap:
        recipe:
            transform: expressions
            output:
                brightness:
                    formula: 0.2043 * nbart_blue + 0.4158 * nbart_green + 0.5524 * nbart_red + 0.5741 * nbart_nir_1 + 0.3124 * nbart_swir_2 + -0.2303 * nbart_swir_3
                    dtype: float32
                greenness:
                    formula: -0.1603 * nbart_blue + -0.2819 * nbart_green + -0.4934 * nbart_red + 0.7940 * nbart_nir_1 + -0.0002 * nbart_swir_2 + -0.1446 * nbart_swir_3
                    dtype: float32
                wetness:
                    formula: 0.0315 * nbart_blue + 0.2021 * nbart_green + 0.3102 * nbart_red + 0.1594 * nbart_nir_1 + -0.6806 * nbart_swir_2 + -0.6109 * nbart_swir_3
                    dtype: float32
            input:
                transform: apply_mask
                mask_measurement_name: fmask
                input:
                    transform: make_mask
                    flags:
                        fmask: valid
                    mask_measurement_name: fmask
                    input:
                        product: s2a_ard_granule
                        measurements: [nbart_blue, nbart_green, nbart_red, nbart_nir_1, nbart_swir_2, nbart_swir_3, fmask]
                        output_crs: EPSG:3577
                        resolution: [-20, 20]
                        resampling:
                            fmask: nearest
                            '*': average
                            

    s2a_mean:
        recipe:
            aggregate: xarray_reduction
            group_by: year
            method: mean
            input: *s2a_cloud_free_recipe


    s2_nbart_rgb:
        recipe:
            collate:
              - product: s2a_ard_granule
                measurements: [nbart_blue, nbart_green, nbart_red]
              - product: s2b_ard_granule
                measurements: [nbart_blue, nbart_green, nbart_red]
